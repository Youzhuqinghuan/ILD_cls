# ILD 间质性肺疾病AI分类系统 - Claude 协助开发指南

## 项目概述

### 项目背景
本项目致力于开发基于HRCT影像的间质性肺疾病(ILD)智能分类系统，通过AI技术实现对UIP、NSIP、OP等不同ILD模式的自动识别和分类。ILD是一组异质性极高的弥漫性肺实质病变，其影像-病理模式的准确判定直接影响治疗策略和预后评估。

### 核心目标
1. **自动病变分割**：基于MedSAM2实现病变区域的精确分割
2. **特征量化分析**：提取四大可解释变量（病变类型、上下肺分布、轴向分布、胸膜下特征）
3. **模式智能分类**：输出UIP、NSIP、OP、Other、Normal五大疾病模式的分类结果
4. **临床可解释性**：提供符合放射学诊断思维的可解释性分析报告

### 技术创新点
- **多模态融合**：结合3D影像、分割掩膜、临床标注的综合分析
- **规则与AI结合**：传统几何算法处理空间特征，深度学习处理复杂模式识别
- **四变量框架**：建立符合临床诊断逻辑的可解释特征体系
- **少样本优化**：针对医学影像数据稀缺性设计的算法策略

## 数据资源分析

### 数据规模与分布
```
总数据规模：322个病例
├── 有分割标签数据：96个病例
│   ├── UIP：23个病例（23.96%）
│   ├── NSIP：14个病例（14.58%）
│   ├── OP：49个病例（51.04%）
│   └── AHP：10个病例（10.42%）
└── 无分割标签数据：226个病例
    ├── UIP：65个病例
    ├── NSIP：21个病例  
    ├── CHP：15个病例
    ├── UNC：45个病例
    └── Normal：80个病例
```

### 标注数据特点
- **标注密度**：96个文件包含2,121个ROI标注，平均每文件22.09个ROI
- **异常征象分布**：实变(792个ROI) > 网格(525个ROI) > 蜂窝(407个ROI) > GGO(404个ROI)
- **空间分布模式**：外周分布占主导(68个文件)，弥漫分布次之(26个文件)
- **胸膜特征**：胸膜下累及(24个文件)，胸膜下省略(13个文件)，混合型(59个文件)

### 数据挑战与机遇
**挑战**：
- 疾病模式不平衡，OP占比过半，NSIP样本最少
- 有分割标签数据相对稀缺(仅96例)
- 多类别细粒度标注，增加了模型学习复杂度

**机遇**：
- 高质量的专家标注，为监督学习提供可靠基础
- 丰富的ROI级别细节，支持细粒度特征学习
- 多模态信息完整，支持综合性分析

### 数据标签情况与技术挑战

#### 稀疏标注特点
**标注策略说明**：
- **部分切片标注**: 每个患者CT仅有部分层面存在病变标签（通常10-25%切片）
- **完整性保证**: 有标签的层面内包含完整的病变类型和病变区域  
- **代表性采样**: 医生标注逻辑为确保每种病变类型都有若干张代表性slice
- **非穷尽性**: 未标注区域不代表无病变，可能存在未标注的病变

**标注分布模式**：
```
患者CT结构（典型案例）：
├── 总切片数：~200层
├── 有标签切片：~20-50层 (10-25%)
│   ├── 标注完整性：✓ 所有病变类型和区域已标注
│   ├── 标注质量：✓ 专家级精确标注  
│   └── 代表性：✓ 涵盖主要病变模式
└── 无标签切片：~150-180层 (75-90%)
    ├── 病变存在性：? 可能存在病变
    ├── 推理需求：✓ 需要预测分割
    └── 挑战：训练-推理域差异
```

#### 核心技术冲突
**训练-推理数据不一致**：
- **训练阶段**: 仅使用有标签切片（稀疏采样）
- **推理目标**: 需对所有切片预测（全覆盖）
- **域适应挑战**: 有标签切片→全切片的泛化问题

**边界框依赖冲突**：
- **训练时**: 基于Ground Truth标签计算精确边界框
- **推理时**: 无GT标签，需要无监督边界框检测策略  
- **一致性要求**: 训练-推理边界框策略需要对齐

## 技术架构与流程

### 核心工作流程
```
输入：3D HRCT + 病变切片序号
    ↓
【病变分割模块】
├── MedSAM2模型：多类病变分割
├── 输入：CT图像 + 提示信息
└── 输出：4类病变掩膜(蜂窝、网格、GGO、实变)
    ↓
【肺部分析模块】  
├── 全肺分割：阈值 + 形态学算法
├── 上下肺划分：基于46分法或几何百分位数
└── 输出：肺部掩膜 + 上下肺分布比例
    ↓
【特征提取模块】
├── 轴向分布：距离变换 + 外周/中心判定(10mm阈值，70%占比)
├── 胸膜下特征：最近距离计算(≤3mm阈值)
├── 病变类型：基于分割结果的多类统计
└── 上下肺分布：病变在上下肺的体积占比
    ↓
【模式分类模块】
├── 四变量融合：病变类型 + 轴向分布 + 胸膜特征 + 上下肺分布
├── 决策策略：医学规则 + 机器学习模型
└── 输出：UIP/NSIP/OP/Other/Normal + 置信度
```

### 关键技术组件

#### 1. 病变分割 (ILD_Segmentation)
- **模型选择**：MedSAM2 - 专为医学影像设计的分割模型
- **微调策略**：基于42例有标注数据进行领域自适应
- **多类处理**：同时分割蜂窝、网格、GGO、实变四类病变
- **提示策略**：结合bbox提示和候选区域检测

#### 2. 肺部分割 (Lung_Segmentation)  
- **分割算法**：传统阈值(-300 HU) + 连通域分析 + 形态学优化
- **上下肺划分**：几何百分位数方法(默认60%分界点)
- **鲁棒性设计**：边界清理 + 孔洞填充 + 噪声过滤
- **体积计算**：基于像素间距的真实体积测量

#### 3. 特征分析 (Generate_Descriptors)
- **距离变换**：计算病变到胸膜表面的欧氏距离
- **轴向分布**：外周(≤10mm或≤20%半径) vs 中心区域，70%占比阈值
- **胸膜下特征**：最近距离≤3mm判定胸膜下累及
- **标准化处理**：相对距离归一化，消除个体差异
