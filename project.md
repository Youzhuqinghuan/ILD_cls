# ILD 间质性肺炎模式分类任务文档

## 1 项目背景与目标

### 1.1 背景

间质性肺疾病（Interstitial Lung Disease, ILD）是一组异质性极高的弥漫性肺实质病变，其 HRCT 表现和病理演变存在显著模式差异（UIP、NSIP、OP、HP 等）。影像‐病理模式的准确判定直接影响治疗策略和预后评估。

### 1.2 总体目标

借助 3D HRCT 影像与部分结构化标签，

1. 自动区分正常与 ILD；
2. 在 ILD 病例中细分 UIP、NSIP、OP、HP 及 UNC（无法归型）模式；
3. 输出诊断所依据的四大可解释变量：病变类型、上下肺分布、轴向分布、胸膜下特征。

---

## 2 数据资源

| 数据类别       | 病例数                                            | 分割标签       | 文字标注 | 说明              |
| ---------- | ---------------------------------------------- | ---------- | ---- | --------------- |
| **有分割有标注** | UIP 1–23<br>NSIP 1–19                          | ✓（蜂窝影、网格影） | ✓    | 训练/验证分割主力       |
| **无分割有标注** | UIP 24–89<br>NSIP 20–40<br>OP 1–50<br>AHP 1–11 | ✗          | ✓    | 训练变量分类头；弱监督扩充掩膜 |
| **无分割无标注** | CHP 1–15<br>UNC 1–45<br>Normal 1–80            | ✗          | ✗    | 仅作推理评估或负样本      |

> **标签缺口**：四类病变(蜂窝影 Honeycomb、网格影 Reticulation、磨玻璃影 GGO、实变影 Consolidation) 仅前两类具备掩膜。GGO/实变影需专家补标或弱监督生成。

---

## 3 问题分解与核心变量

| 变量     | 取值                                             | 计算来源              |
| ------ | ---------------------------------------------- | ----------------- |
| 病变类型   | Honeycomb / Reticulation / GGO / Consolidation | MedSAM2 多类掩膜      |
| 上/下肺分布 | Upper / Lower 优势                               | 掩膜体素占比（冠状面或纵向三等分） |
| 轴向分布   | Peripheral / Central / Diffuse                 | 掩膜在肺横截面相对胸壁位置     |
| 胸膜下特征  | Subpleural / Non‑subpleural                    | 掩膜与肺外缘距离或贴壁面积     |

四变量经规则/模型融合映射为模式标签：UIP、NSIP、OP、HP、UNC、Normal。

---

## 4 技术路线

```
3D CT → 预处理 → 提示生成 → MedSAM2 分割 → 变量提取 → 规则/轻量模型融合 → 模式输出
```

### 4.1 输入与预处理

* **输入**：3D HRCT + 已知含病变切片序号。
* **肺实质分割**：快速阈值 + 形态学法剔除胸壁；得到肺 ROI。

### 4.2 提示生成（二路并行）

| 路径                   | 数据来源  | 生成方式                                                                                   |
| -------------------- | ----- | -------------------------------------------------------------------------------------- |
| **A**                | 有掩膜病例 | 由真值掩膜自动提取外接 bbox 作为 prompts                                                            |
| **B**                | 无掩膜病例 | Candidate Region Proposal：<br>  • 密度阈值/GGO 滤波<br>  • 滑窗/连通域寻找异常区<br>  → 粗 bbox prompts |
| 二者箭头均指向 **MedSAM2**。 |       |                                                                                        |

### 4.3 MedSAM2 分割

* **模型**：基于 SAM 的医学版；先全域预训练，后在 42 例蜂窝/网格掩膜微调。
* **多类策略**：依次提示分割 4 类病变；或修改输出层为多通道概率图 (需足量掩膜)。
* **输出**：3D 病灶掩膜（多标签）。

### 4.4 变量计算模块

1. **病变类型**：由掩膜类别直接得到。<br>
2. **上下肺分布**：纵向按比例切分肺；统计体素数比值。<br>
3. **轴向分布**：计算掩膜至胸壁欧氏距离；或环带分区投影占比。<br>
4. **胸膜下特征**：测掩膜在距肺轮廓 ≤10 mm 区域的占比。

### 4.5 决策融合

* **医学硬规则**（示例）：

  * 蜂窝影 + 胸膜下 + 下肺优势 → UIP
  * 无蜂窝影 + GGO 或网格影 + 弥漫/上肺 → NSIP
  * GGO/实变影为主 + 可迁移 → OP / HP
* **软决策**：在硬规则冲突或变量缺失时，使用 Logistic/Bayesian 网络基于四变量概率输出模式，容错并给低置信度标记。

---

## 5 训练与验证计划

| 阶段        | 目标         | 数据            | 关键指标               |
| --------- | ---------- | ------------- | ------------------ |
| **分割微调**  | 多类病灶掩膜     | 42 例掩膜 (+ 补标) | DSC, Recall, F1    |
| **变量分类头** | 轴向分布、胸膜下判定 | 200 例文字标注     | Accuracy, AUC      |
| **融合层训练** | 模式预测       | 有标注全部         | 模式分类 Accuracy / F1 |

交叉验证：病例级五折；Normal 与 UNC 用作外部测试。

---

## 6 风险与改进

1. **GGO/实变影缺标注** → 专家半自动补标；LoG 过滤生成弱标签。
2. **提示依赖** → 研发候选区域检测器，或在 MedSAM2 内置递归切片传播。
3. **少样本过拟合** → 大幅数据增强（随机旋转翻转、对比度缩放、PatchMix）。
4. **多阶段误差累积** → 在融合层引入置信度门控与人机协作。
